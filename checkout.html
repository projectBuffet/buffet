<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <style>
        .checkout-form {
            max-width: 400px;
            margin: auto;
            padding: 20px;
            border: 1px solid #ddd;
        }
        .checkout-form label {
            display: block;
            margin-bottom: 10px;
        }
        .checkout-form input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
        }
        .checkout-form button {
            background-color: blue;
            color: white;
            padding: 10px;
            border: none;
            cursor: pointer;
            width: 100%;
        }
    </style>
    <script src="https://js.stripe.com/v3/"></script> <!-- 引入 Stripe JS -->
</head>
<body>
    <h1>Checkout</h1>

    <div class="checkout-form">
        <form id="payment-form">
            <!-- 用户输入姓名 -->
            <label for="card-holder-name">Card Holder Name</label>
            <input id="card-holder-name" type="text" placeholder="Card Holder Name" required>

            <!-- 用户输入邮箱 -->
            <label for="email">Email</label>
            <input id="email" type="email" placeholder="Email" required>

            <!-- 用户输入地址信息 -->
            <label for="address-line1">Address Line 1</label>
            <input id="address-line1" type="text" placeholder="1234 Main St" required>

            <label for="city">City</label>
            <input id="city" type="text" placeholder="City" required>

            <label for="state">State</label>
            <input id="state" type="text" placeholder="State" required>

            <label for="postal-code">Postal Code</label>
            <input id="postal-code" type="text" placeholder="Postal Code" required>

            <label for="country">Country</label>
            <input id="country" type="text" value="US" placeholder="Country" required>

            <!-- Stripe 卡片输入框 -->
            <div id="card-element"><!-- Stripe Card Element 将显示在此 --></div>
            <div id="card-errors" role="alert"></div>

            <!-- 提交按钮 -->
            <button type="submit" id="submit">Pay</button>
        </form>
    </div>

    <script>
        // 初始化 Stripe
        var stripe = Stripe('pk_live_你的公共密钥');  // 使用你的 Stripe 公钥
        var elements = stripe.elements();

        // 创建一个卡片输入框，启用邮政编码字段
        var card = elements.create('card', {
          hidePostalCode: false,
          style: {
            base: {
              color: '#32325d',
              fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
              fontSmoothing: 'antialiased',
              fontSize: '16px',
              '::placeholder': {
                color: '#aab7c4'
              }
            },
            invalid: {
              color: '#fa755a',
              iconColor: '#fa755a'
            }
          }
        });
        card.mount('#card-element');

        // 处理支付表单的提交
        var form = document.getElementById('payment-form');
        form.addEventListener('submit', function(event) {
            event.preventDefault();

            // 获取购物车总金额
            const totalAmount = localStorage.getItem('totalAmount');
            console.log('Total amount (in cents): ', totalAmount);

            if (!totalAmount || isNaN(totalAmount)) {
                alert('Amount is missing or invalid');
                return;
            }

            stripe.createPaymentMethod({
                type: 'card',
                card: card,
                billing_details: {
                  name: document.getElementById('card-holder-name').value,
                  email: document.getElementById('email').value,
                  address: {
                    line1: document.getElementById('address-line1').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    postal_code: document.getElementById('postal-code').value,
                    country: document.getElementById('country').value
                  }
                }
            }).then(function(result) {
                if (result.error) {
                    var errorElement = document.getElementById('card-errors');
                    errorElement.textContent = result.error.message;
                } else {
                    // 将付款信息发送到服务器端进行处理
                    fetch('https://us-central1-capable-code-279907.cloudfunctions.net/create-checkout-session', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            payment_method_id: result.paymentMethod.id,
                            amount: totalAmount
                        }),
                    }).then(function(response) {
                        return response.json();
                    }).then(function(session) {
                        // 在支付成功后跳转到成功页面
                        if (session.success) {
                            window.location.href = "https://projectbuffet.com/success.html";  // 成功页面的 URL
                        } else {
                            alert("Payment failed, please try again.");
                        }
                    }).catch(function(error) {
                        console.log('Error during payment:', error);
                    });
                }
            });
        });
    </script>
</body>
</html>